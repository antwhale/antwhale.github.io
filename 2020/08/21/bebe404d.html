<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="keywords" content="MyBatis, MyBatis技术内幕">
    <meta name="description" content="Ant丶的网络日志, CAYZLH网络日志, CAYZLH, CAYZLH主页, Ant丶空间">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->

    <meta name="google-site-verification" content="VrcbMTVpFGlHkIERHBt753dAtXKF4qirjnDweuXSRJw">


    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-129095667-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-129095667-1');
</script>


    <title>核心处理层-SqlNode&amp;SqlSource | BLOG | CAYZLH</title>

    
    <!-- Third-Party CSS -->
    

        <link rel="shortcut icon" href="/blog/image/favicon.ico">
        <link rel="icon" type="image/png" href="/blog/image/favicon-192x192.png" sizes="192x192">
        <link rel="apple-touch-icon" sizes="180x180" href="/blog/image/apple-touch-icon.png">

        <link rel="stylesheet" href="/blog/css/thirdparty/bootstrap.min.css">
        <link rel="stylesheet" href="/blog/css/thirdparty/octicons.css">
        <link rel="stylesheet" href="/blog/css/thirdparty/hover-min.css">
        <link rel="stylesheet" href="/blog/css/thirdparty/user-content.min.css">
        <link rel="stylesheet" href="/blog/css/thirdparty/syntax.css">
        <link rel="stylesheet" href="/blog/css/thirdparty/gitalk.css">

        <!-- My CSS -->
        <link rel="stylesheet" href="/blog/css/common.css">

        <link rel="stylesheet" href="/blog/css/sidebar-post-nav.css">

        <link rel="stylesheet" href="/blog/css/blog-page.css">
        <!-- CSS set in page -->

        
        <link rel="stylesheet" href="/blog/css/sidebar-popular-repo.css">
    

    <!-- CSS set in layout -->
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">

    
        <script type="text/javascript" src="/blog/js/thirdparty/jquery.min.js"></script>
        <script type="text/javascript" src="/blog/js/thirdparty/bootstrap.min.js"></script>
        <script type="text/javascript" src="/blog/js/lock.js"></script>
    

    
        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

        <link rel="stylesheet" href="//imsun.github.io/gitment/style/default.css">
        <script src="//imsun.github.io/gitment/dist/gitment.browser.js"></script>

        <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
        <script src="//cdn.jsdelivr.net/npm/twikoo@1.2.0/dist/twikoo.all.min.js"></script>

    

    <link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css">
    <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/blog/atom.xml" title="BLOG | CAYZLH" type="application/atom+xml">
</head>

<body>
<header class="site-header">
    <div class="site-header-topbar">
        <div class="container">
            <div class="topbar-menu">

    
        <div class="item">
            <a href="https://www.cayzlh.com" title="导航">
                导航
            </a>
        </div>
    
        <div class="item">
            <a href="/blog/categories/" title="分类">
                分类
            </a>
        </div>
    
        <div class="item">
            <a href="/blog/tags/" title="标签">
                标签
            </a>
        </div>
    
        <div class="item">
            <a href="/blog/links/" title="链接">
                链接
            </a>
        </div>
    
        <div class="item">
            <a href="/blog/about" title="关于">
                关于
            </a>
        </div>
    

</div>
        </div>
    </div>
    <div class="container">
        <a id="site-header-brand" href="/blog/" title="BLOG | CAYZLH">
            <span class="octicon octicon-mark-github"></span>
            BLOG | CAYZLH
        </a>

        <nav class="site-header-nav" role="navigation">
    
        <div class=" site-header-nav-item hvr-underline-from-center">
            <a href="/blog/" title="Home">
                Home
            </a>
            
        </div>
    
        <div class=" site-header-nav-item hvr-underline-from-center">
            <a href="/blog/archives" title="Archives">
                Archives
            </a>
            
        </div>
    
        <div class=" site-header-nav-item hvr-underline-from-center">
            <a href="/blog/" title="Learning">
                Learning
            </a>
            
                <ul class="submenu">
                    

                        <li>
                            <a href="/blog/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8A%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E3%80%8B/">
                                <span>深入理解Java虚拟机</span>
                            </a>
                        </li>

                    

                        <li>
                            <a href="/blog/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/">
                                <span>MyBatis技术内幕</span>
                            </a>
                        </li>

                    

                        <li>
                            <a href="/blog/categories/Java/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">
                                <span>Java设计模式</span>
                            </a>
                        </li>

                    
                </ul>
            
        </div>
    
</nav>
    </div>
</header>
<main class="content">
    <!-- 标题部分 -->
<section class="jumbotron geopattern" data-pattern-id="核心处理层-SqlNode&SqlSource">
    <div class="container">
        <div id="jumbotron-meta-info">
            <h1>核心处理层-SqlNode&amp;SqlSource</h1>
            <span class="meta-info">
                <a><span class="octicon octicon-calendar"></span> 2020-08-21</a>
                
                    <a><span class="octicon octicon-book"></span></a>
                    
                        <a href="/blog/categories/%E4%B9%A6%E7%B1%8D/">书籍</a>
                    
                        <a href="/blog/categories/%E4%B9%A6%E7%B1%8D/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/">《MyBatis技术内幕》</a>
                    
                
                
                    
                
            </span>
        </div>

    </div>
</section>
<script>
    $(document).ready(function(){

        $('.geopattern').each(function(){
            $(this).geopattern($(this).data('pattern-id'));
        });

    });
</script>
<!-- 文章内容部分 -->
<article class="post container " itemscope itemtype="http://schema.org/BlogPosting" id="openwrite-container">
    <div class="row">
        <div class="col-md-9 markdown-body">
            <!-- 文章开始部分 -->
            <!--<div style="text-align:center">-->
<!--    <img style="display:inline-block" width="130" height="27"-->
<!--         src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/640-3.gif"-->
<!--         data-loaded="true">-->
<!--    <img style="display:inline-block" width="41" height="35"-->
<!--         src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/640-4.gif"-->
<!--         data-loaded="true">-->
<!--    <img style="display:inline-block"-->
<!--         width="130" height="27"-->
<!--         src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/640-5.gif"-->
<!--         data-loaded="true">-->
<!--</div>-->
            <p>核心处理层以基础支持层为基础，实现了<code>MyBatis</code>的核心功能。这个部分将从<code>MyBatis</code>的初始化、动态<code>SQL</code>语句的解析、结果集的映射、参数解析以及<code>SQL</code>语句的执行等几个方面分析<code>MyBatis</code>的核心处理层，了解<code>MyBatis</code>的核心原理。</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/06/22/image-20200622175512211_aegXOG.png" alt="image-20200622175512211"></p>
<blockquote>
<p>本篇介绍SqINode&amp;SqISource</p>
</blockquote>
<p>映射配置文件中定义的<code>SQL</code>节点会被解析成<code>MappedStatement</code>对象，其中的<code>SQL</code>语句会被解析成<code>SqlSource</code>对象，<code>SQL</code>语句中定义的动态<code>SQL</code>节点、文本节点等，则由<code>SqlNode</code>接口的相应实现表示。</p>
<p><code>SqlSource</code>接口的定义：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SqlSource</span> <span class="token punctuation">{</span>

  BoundSql <span class="token function">getBoundSql</span><span class="token punctuation">(</span>Object parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>SqlSource</code>接口的实现类图：</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/08/17323715982615571598261557744.png" alt="image-20200824173236987"></p>
<ul>
<li><code>DynamicSqlSource</code>负责处理动态<code>SQL</code>语句，<code>RawSqlSource</code>负责处理静态语句，两者最终都会将处理后的<code>SQL</code>语句封装成<code>StaticSqlSource</code>返回。</li>
<li><code>DynamicSqlSource</code>与<code>StaticSqlSource</code>的主要区别：<ul>
<li><code>StaticSqlSource</code>中记录的<code>SQL</code>语句中可能含有<code>?</code>占位符，但是可以直接提交给数据库执行</li>
<li><code>DynamicSqlSource</code>中封装的<code>SQL</code>语句还需要进行一系列解析，才会最终形成数据库可执行的<code>SQL</code>语句</li>
</ul>
</li>
</ul>
<h2 id="组合模式"><a href="#组合模式" class="headerlink" title="组合模式"></a>组合模式</h2><p>组合模式是将对象组合成树形结构，以表示<code>部分-整体</code>的层次结构(一般是树形结构)，用户可以像处理一个简单对象一样来处理一个复杂对象，从而使得调用者无须了解复杂元素的内部结构。</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/08/17400415982620041598262004554.png" alt="image-20200824174003381"></p>
<p>组合模式中的各模式如下：</p>
<ul>
<li><p><strong>抽象组件(<code>Component</code>)</strong></p>
<p><code>Component</code>接口定义了树形结构中所有类的公共行为，例如这里的<code>operation()</code>方法。</p>
<p>一般情况下，其中还会定义一些用于管理子组件的方法，例如这里的<code>add()</code>、<code>remove()</code>、<code>getChild()</code>方法。</p>
</li>
<li><p><strong>树叶(<code>Leaf</code>)</strong></p>
<p><code>Leaf</code>在树形结构中表示叶节点对象，叶节点没有子节点。</p>
</li>
<li><p><strong>树枝(<code>Composite</code>)</strong></p>
<p>定义有子组件的那些组件的行为。该角色用于管理子组件，并通过<code>operation()</code>方法调用其管理的子组件的相关操作。</p>
</li>
<li><p><strong>调用者(<code>Client</code>)</strong></p>
<p>通过<code>Component</code>接口操纵整个树形结构。</p>
</li>
</ul>
<p><u>组合模式主要有两点好处</u>，<strong>首先组合模式可以帮助调用者屏蔽对象的复杂性</strong>。</p>
<p>对于调用者来说，使用整个树形结构与使用单个<code>Component</code>对象没有任何区别，也就是说，调用者并不必关心自己处理的是单个<code>Component</code>对象还是整个树形结构，这样就可以将调用者与复杂对象进行解耦。</p>
<p>另外，<strong>使用了组合模式之后，我们可以通过增加树中节点的方式，添加新的Component对象，从而实现功能上的扩展，这符合<code>开放-封闭</code>原则，也可以简化日后的维护工作。</strong></p>
<p><u>组合模式在带来上述好处的同时，也会引入一些问题</u>。</p>
<p>例如，有些场景下程序希望一个组合结构中只能有某些特定的组件，此时就很难直接通过组件类型进行限制(因为都是<code>Component</code>接口的实现类)，这就必须在运行时进行类型检测。而且，在递归程序中定位问题也是一件比较复杂的事情。</p>
<p><code>MyBatis</code>在处理动态<code>SQL</code>节点时，应用到了组合设计模式。<code>MyBatis</code>会将动态<code>SQL</code>节点解析成对应的<code>SqlNode</code>实现，并形成树形结构。</p>
<h2 id="OGNL表达式"><a href="#OGNL表达式" class="headerlink" title="OGNL表达式"></a>OGNL表达式</h2><p><code>OGNL</code>(<strong>Object Graphic Navigation Language，对象图导航语言</strong>)表达式在<code>Struts</code>、<code>MyBatis</code>等开源项目中有广泛的应用，其中<code>Struts</code>框架更是将<code>OGNL</code>作为默认的表达式语言。</p>
<p>在<code>MyBatis</code>中涉及的<code>OGNL</code>表达式的功能主要是：<strong>存取<code>Java</code>对象树中的属性</strong>、<strong>调用<code>Java</code>对象树中的方法等</strong>。</p>
<p><strong>OGNL中的几个概念：</strong></p>
<ul>
<li><p><strong>表达式</strong></p>
<p><code>OGNL</code>表达式执行的所有操作都是根据表达式解析得到的。</p>
<p>例如：</p>
<p><code>对象名.方法名</code>表示调用指定对象的指定方法</p>
<p><code>@[类的完全限定名]@[静态方法或静态字段]</code>表示调用指定类的静态方法或访问静态字段</p>
<p><code>OGNL</code>表达式还可以完成<u>变量赋值</u>、<u>操作集合</u>等操作。</p>
</li>
<li><p><strong>root对象</strong></p>
<p><code>OGNL</code>表达式指定了具体的操作，而<code>root</code>对象指定了需要操作的对象。</p>
</li>
<li><p><strong>OgnlContext（上下文对象）</strong></p>
<p><code>OgnlContext</code>类继承了<code>Map</code>接口，<code>OgnlContext</code>对象说白了也就是一个<code>Map</code>对象。</p>
<p>既然如此，<code>OgnIContext</code>对象中就可以存放除<code>root</code>对象之外的其他对象。</p>
<p>在使用<code>OGNL</code>表达式操作非<code>root</code>对象时，需要使用<code>#</code>前缀，而操作<code>root</code>对象则不需要使用<code>#</code>前缀。</p>
</li>
</ul>
<p>在<code>MyBatis</code>中，使用<code>OgnlCache</code>对原生的<code>OGNL</code>进行了封装。<code>OGNL</code>表达式的解析过程是比较耗时的，为了提高效率，<code>OgnlCache</code>中使用<code>expressionCache</code>字段(静态成员，<code>ConcurrentHashMap&lt;String,Object&gt;</code>类型)对解析后的<code>OGNL</code>表达式进行缓存。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> expressionCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> Object <span class="token function">getValue</span><span class="token punctuation">(</span>String expression<span class="token punctuation">,</span> Object root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    Map<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> OgnlClassResolver<span class="token operator">></span> context <span class="token operator">=</span> Ognl<span class="token punctuation">.</span><span class="token function">createDefaultContext</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OgnlClassResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Ognl<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OgnlException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BuilderException</span><span class="token punctuation">(</span><span class="token string">"Error evaluating expression '"</span> <span class="token operator">+</span> expression <span class="token operator">+</span> <span class="token string">"'. Cause: "</span> <span class="token operator">+</span> e<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> Object <span class="token function">parseExpression</span><span class="token punctuation">(</span>String expression<span class="token punctuation">)</span> <span class="token keyword">throws</span> OgnlException <span class="token punctuation">{</span>
  Object node <span class="token operator">=</span> expressionCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    node <span class="token operator">=</span> Ognl<span class="token punctuation">.</span><span class="token function">parseExpression</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span><span class="token punctuation">;</span>
    expressionCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> node<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="DynamicContext"><a href="#DynamicContext" class="headerlink" title="DynamicContext"></a>DynamicContext</h2><p><code>DynamicContext</code>主要用于记录解析动态<code>SQL</code>语句之后产生的<code>SQL</code>语句片段，可以认为它是一个用于记录动态<code>SQL</code>语句解析结果的容器。</p>
<p>其中有两个核心字段：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 参数上下文</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> ContextMap bindings<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 在SqlNode解析动态sql的时候，会将解析后的sql语句片段添加到该属性中保存，最终拼凑出一条完整的sql语句</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> StringBuilder sqlBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>ContextMap</code>是<code>DynamicContext</code>中定义的内部类，它实现了<code>HashMap</code>并重写了<code>get()</code>方法。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ContextMap</span> <span class="token keyword">extends</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> 2977601501966151582L<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 将用户传的参数封装成MetaObject对象</span>
  <span class="token keyword">private</span> MetaObject parameterMetaObject<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token function">ContextMap</span><span class="token punctuation">(</span>MetaObject parameterMetaObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>parameterMetaObject <span class="token operator">=</span> parameterMetaObject<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> Object <span class="token function">get</span><span class="token punctuation">(</span>Object key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    String strKey <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> key<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>strKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>strKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>parameterMetaObject <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// issue #61 do not modify the context when reading</span>
      <span class="token keyword">return</span> parameterMetaObject<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>strKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>DynamicContext</code>的构造方法会初始化<code>bindings</code>集合，注意构造方法的第二个参数<code>pammeterObject</code>，它是运行时用户传入的参数，其中包含了后续用于替换<code>#{}</code>占位符的实参。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token function">DynamicContext</span><span class="token punctuation">(</span>Configuration configuration<span class="token punctuation">,</span> Object parameterObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parameterObject <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>parameterObject <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 对于不是Map类型的参数，会创装MetaObject对象，并封装成ContextMap对象</span>
    MetaObject metaObject <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">newMetaObject</span><span class="token punctuation">(</span>parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bindings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContextMap</span><span class="token punctuation">(</span>metaObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    bindings <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ContextMap</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  bindings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>PARAMETER_OBJECT_KEY<span class="token punctuation">,</span> parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bindings<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>DATABASE_ID_KEY<span class="token punctuation">,</span> configuration<span class="token punctuation">.</span><span class="token function">getDatabaseId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="SqlNode"><a href="#SqlNode" class="headerlink" title="SqlNode"></a>SqlNode</h2><p>接下来看看SqlNode的实现类是如何解析其对应的SQL节点。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SqlNode</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// apply()是SqlNode接口中定义的唯一方法，该方法会根据用户传入的实参，参数解析该SqlNode所</span>
  <span class="token comment" spellcheck="true">// 记录的动态SQL节点，并调用DynamicContext.appendSql()方法将解析后的SQL片段追加到</span>
  <span class="token comment" spellcheck="true">// DynamicContext.sqlBuilder中保存</span>
  <span class="token comment" spellcheck="true">// 当SQL节点下的所有SqlNode完成解析后，我们就可以从DynamicContext中获取一条动态生成的、</span>
  <span class="token comment" spellcheck="true">// 完整的SQL语句</span>
  <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span>DynamicContext context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>SqlNode</code>接口有多个实现类，每个实现类对应一个动态<code>SQL</code>节点。按照组合模式的角色来划分，<code>SqlNode</code>扮演了抽象组件的角色，<code>MixedSqlNode</code>扮演了树枝节点的角色，<code>TextSqlNode</code>节点扮演了树叶节点的角色等等。</p>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/08/16395615983447961598344796478.png" alt="image-20200825163955175"></p>
<p><strong>1、StaticTextSqINode&amp;MixedSqINode</strong></p>
<p><code>StaticTextSqINode</code>中使用<code>text</code>字段(<code>String</code>类型)记录了对应的非动态<code>SQL</code>语句节点，其<code>apply()</code>方法直接将<code>text</code>字段追加到<code>DynamicContext.sqlBuilder</code>字段中。</p>
<p><code>MixedSqINode</code>中使用<code>contents</code>字段(<code>List&lt;SqlNode&gt;</code>类型)记录其子节点对应的<code>SqlNode</code>对象集合，其<code>apply()</code>方法会循环调用<code>contents</code>集合中所有<code>SqlNode</code>对象的<code>apply()</code>方法。</p>
<p><strong>2、TextSqlNode</strong></p>
<p><u><code>TextSqlNode</code>表示的是包含占位符的动态<code>SQL</code>节点。</u><code>TextSqlNode.apply()</code>方法会使用<code>GenericTokenParser</code>解析<code>${}</code>占位符，并直接替换成用户给定的实际参数值。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span>DynamicContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 创建GenericTokenParser解析器，</span>
  GenericTokenParser parser <span class="token operator">=</span> <span class="token function">createParser</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BindingTokenParser</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> injectionFilter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 将解析后的SQL片段添加到DynamicContext中</span>
  context<span class="token punctuation">.</span><span class="token function">appendSql</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> GenericTokenParser <span class="token function">createParser</span><span class="token punctuation">(</span>TokenHandler handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GenericTokenParser</span><span class="token punctuation">(</span><span class="token string">"${"</span><span class="token punctuation">,</span> <span class="token string">"}"</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong><code>BindingTokenParser</code></strong>是<code>TextSqlNode</code>中定义的内部类，继承了<code>TokenHandler</code>接口，<u>它的主要功能是根据<code>DynamicContext.bindings</code>集合中的信息解析<code>SQL</code>语句节点中的<code>${}</code>占位符</u>。<code>BindingTokenParser.context</code>字段指向了对应的<code>DynamicContext</code>对象。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BindingTokenParser</span> <span class="token keyword">implements</span> <span class="token class-name">TokenHandler</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> DynamicContext context<span class="token punctuation">;</span>
  <span class="token keyword">private</span> Pattern injectionFilter<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">BindingTokenParser</span><span class="token punctuation">(</span>DynamicContext context<span class="token punctuation">,</span> Pattern injectionFilter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>injectionFilter <span class="token operator">=</span> injectionFilter<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> String <span class="token function">handleToken</span><span class="token punctuation">(</span>String content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object parameter <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"_parameter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parameter <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>SimpleTypeRegistry<span class="token punctuation">.</span><span class="token function">isSimpleType</span><span class="token punctuation">(</span>parameter<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> parameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Object value <span class="token operator">=</span> OgnlCache<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    String srtValue <span class="token operator">=</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// issue #274 return "" instead of "null"</span>
    <span class="token function">checkInjection</span><span class="token punctuation">(</span>srtValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> srtValue<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkInjection</span><span class="token punctuation">(</span>String value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>injectionFilter <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>injectionFilter<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ScriptingException</span><span class="token punctuation">(</span><span class="token string">"Invalid input. Please conform to regex"</span> <span class="token operator">+</span> injectionFilter<span class="token punctuation">.</span><span class="token function">pattern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>3、IfSqlNode</strong></p>
<p><code>IfSqlNode</code>对应的动态<code>SQL</code>节点是<code>&lt;if&gt;</code>节点，以下是几个核心字段。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 用于解析if节点的test表达式的值</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> ExpressionEvaluator evaluator<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 记录了test表达式</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> String test<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 记录子节点</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> SqlNode contents<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>IfSqlNode.apply()</code>方法首先会通过<code>ExpressionEvaluator.evaluateBoolean()</code>方法检测其<code>test</code>表达<br>式是否为<code>true</code>，然后根据<code>test</code>表达式的结果，决定是否执行其子节点的<code>apply()</code>方法。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span>DynamicContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>evaluator<span class="token punctuation">.</span><span class="token function">evaluateBoolean</span><span class="token punctuation">(</span>test<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    contents<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">evaluateBoolean</span><span class="token punctuation">(</span>String expression<span class="token punctuation">,</span> Object parameterObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object value <span class="token operator">=</span> OgnlCache<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>expression<span class="token punctuation">,</span> parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Boolean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BigDecimal</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>BigDecimal<span class="token punctuation">.</span>ZERO<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> value <span class="token operator">!=</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>4、TrimSqINode&amp;WhereSqINode&amp;SetSqINode</strong></p>
<p><code>TrimSqlNode</code>会根据子节点的解析结果，添加或删除相应的前缀或后缀。其中几个字段如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 记录子节点</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> SqlNode contents<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// SQL语句添加的前缀</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> String prefix<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// SQL语句添加的后缀</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> String suffix<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// </span>
<span class="token keyword">private</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> prefixesToOverride<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> suffixesToOverride<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在<code>TrimSqlNode</code>的构造函数中，会调用<code>parseOverrides()</code>方法对参数<code>prefixesToOverride</code>(对应<code>&lt;trim&gt;</code>节点的<code>prefixOverrides</code>属性)和参数<code>suffixesToOverride</code>(对应<code>&lt;trim&gt;</code>节点的<code>suffixOverrides</code>属性)进行解析，并初始化<code>prefixesToOverride</code>和<code>sufflxesToOverride</code>。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">parseOverrides</span><span class="token punctuation">(</span>String overrides<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>overrides <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> StringTokenizer parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringTokenizer</span><span class="token punctuation">(</span>overrides<span class="token punctuation">,</span> <span class="token string">"|"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">countTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">hasMoreTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span>Locale<span class="token punctuation">.</span>ENGLISH<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>TrimSqlNode.apply()</code>方法首先解析子节点，然后根据子节点的解析结果处理前缀和后缀。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">apply</span><span class="token punctuation">(</span>DynamicContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 创建FilteredDynamicContext对象，其中封装了DynamicContext</span>
  FilteredDynamicContext filteredDynamicContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilteredDynamicContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 调用子节点的apply方法进行解析</span>
  <span class="token keyword">boolean</span> result <span class="token operator">=</span> contents<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>filteredDynamicContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 处理前缀和后缀</span>
  filteredDynamicContext<span class="token punctuation">.</span><span class="token function">applyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>处理前缀和后缀的主要逻辑是在<code>FilteredDynamicContext</code>中实现的，它继承了<code>DynamicContext</code>，同时也是<code>DynamicContext</code>的代理类。</p>
<p><code>FilteredDynamicContext</code>除了将对应方法调用委托给其中封装的<code>DynamicContext</code>对象，还提供了处理前缀和后缀的<code>applyAll()</code>方法。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">FilteredDynamicContext</span> <span class="token keyword">extends</span> <span class="token class-name">DynamicContext</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 底层封装的DynamicContext对象</span>
  <span class="token keyword">private</span> DynamicContext delegate<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 是否已经处理过前缀和后缀</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> prefixApplied<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> suffixApplied<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 记录子节点解析过后的结果</span>
  <span class="token keyword">private</span> StringBuilder sqlBuffer<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// ...</span>
  <span class="token comment" spellcheck="true">// ...</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">applyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 获取子节点解析过后的结果，并全部转换为大写</span>
    sqlBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>sqlBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    String trimmedUppercaseSql <span class="token operator">=</span> sqlBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span>Locale<span class="token punctuation">.</span>ENGLISH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>trimmedUppercaseSql<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">applyPrefix</span><span class="token punctuation">(</span>sqlBuffer<span class="token punctuation">,</span> trimmedUppercaseSql<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 处理前缀</span>
      <span class="token function">applySuffix</span><span class="token punctuation">(</span>sqlBuffer<span class="token punctuation">,</span> trimmedUppercaseSql<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 处理后缀</span>
    <span class="token punctuation">}</span>
    delegate<span class="token punctuation">.</span><span class="token function">appendSql</span><span class="token punctuation">(</span>sqlBuffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// ...</span>
  <span class="token comment" spellcheck="true">// ...</span>

  <span class="token comment" spellcheck="true">// 处理前缀</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">applyPrefix</span><span class="token punctuation">(</span>StringBuilder sql<span class="token punctuation">,</span> String trimmedUppercaseSql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prefixApplied<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      prefixApplied <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>prefixesToOverride <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String toRemove <span class="token operator">:</span> prefixesToOverride<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>trimmedUppercaseSql<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>toRemove<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sql<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> toRemove<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>prefix <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sql<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sql<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> prefix<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// 处理后缀</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">applySuffix</span><span class="token punctuation">(</span>StringBuilder sql<span class="token punctuation">,</span> String trimmedUppercaseSql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>suffixApplied<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      suffixApplied <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>suffixesToOverride <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String toRemove <span class="token operator">:</span> suffixesToOverride<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>trimmedUppercaseSql<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>toRemove<span class="token punctuation">)</span> <span class="token operator">||</span> 
              trimmedUppercaseSql<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span>toRemove<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> start <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> toRemove<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> end <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sql<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>suffix <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sql<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sql<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>suffix<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><u><code>WhereSqlNode</code>和<code>SetSqlNode</code>都继承了<code>TrimSqlNode</code></u>。</p>
<p>其中<code>WhereSqlNode</code>指定了<code>prefix</code>字段为<code>WHERE</code>，<code>prefixesToOverride</code>集合中的项为<code>AND</code>和<code>OR</code>，<code>suffix</code>字段和<code>suffixesToOverride</code>集合为<code>null</code>。也就是说，<code>&lt;where&gt;</code>节点解析后的<code>SQL</code>语句片段如果以<code>AND</code>或<code>OR</code>开头，则将开头处的<code>AND</code>或<code>OR</code>删除，之后再将<code>WHERE</code>关键字添加到<code>SQL</code>片段开始位置，从而得到该<code>&lt;where&gt;</code>节点最终生成的<code>SQL</code>片段。</p>
<p><code>SetSqlNode</code>指定了<code>prefix</code>字段为<code>SET</code>，<code>suffixesToOverride</code>集合中的项只有<code>suffix</code>字段和<code>prefixesToOverride</code>集合为<code>null</code>。也就是说，<code>&lt;set&gt;</code>节点解析后的<code>SQL</code>语句片段如果以<code>,</code>结尾，则将结尾处的删除掉，之后再将<code>SET</code>关键字添加到<code>SQL</code>片段的开始位置，从而得到该<code>&lt;set&gt;</code>节点最终生成的<code>SQL</code>片段。</p>
<p><strong>5、ForeachSqINode</strong></p>
<p>在动态<code>SQL</code>语句中构建<code>IN</code>条件语句的时候，通常需要对一个集合进行迭代，<code>MyBatis</code>提供了<code>&lt;foreach&gt;</code>标签实现该功能。在使用<code>&lt;foreach&gt;</code>标签迭代集合时，不仅可以使用集合的元素和索引值，还可以在循环开始之前或结束之后添加指定的字符串，也允许在迭代过程中添加指定的分隔符。</p>
<p>解析<code>&lt;foreach&gt;</code>节点对应的<code>sqlnode</code>实现类是<code>ForeachSqlNode</code>，以下是其中定义的字段：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 用于判断循环的终止条件，ForeachSqlNode构造方法中会创建该对象</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> ExpressionEvaluator evaluator<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 迭代的集合表达式</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> String collectionExpression<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 子节点</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> SqlNode contents<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 循环开始前要添加的字符串</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> String open<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 循环结束时要添加的字符串</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> String close<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 分隔符</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> String separator<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 本次迭代的元素</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> String item<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 当前迭代的次数</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> String index<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 配置</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> Configuration configuration<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>ForeachSqINode</code>中有两个内部类，分别是<code>PrefixedContext</code>和<code>FilteredDynamicContext</code>，它们都继承了<code>DynamicContext</code>，同时也都是<code>DynamicContext</code>的代理类。</p>
<p><strong><code>PreFixedContext</code></strong></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">PrefixedContext</span> <span class="token keyword">extends</span> <span class="token class-name">DynamicContext</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> DynamicContext delegate<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> String prefix<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 是否已经处理过前缀</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> prefixApplied<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// ...</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">appendSql</span><span class="token punctuation">(</span>String sql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prefixApplied <span class="token operator">&amp;&amp;</span> sql <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> sql<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 是否需要追加前缀</span>
      delegate<span class="token punctuation">.</span><span class="token function">appendSql</span><span class="token punctuation">(</span>prefix<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 追加前缀</span>
      prefixApplied <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    delegate<span class="token punctuation">.</span><span class="token function">appendSql</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 追加sql</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong><code>FilteredDynamicContext</code></strong></p>
<p><code>FilteredDynamicContext</code>负责处理<code>#{}</code>占位符，但它并未完全解析<code>#{}</code>占位符。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">FilteredDynamicContext</span> <span class="token keyword">extends</span> <span class="token class-name">DynamicContext</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// DynamicContext对象</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> DynamicContext delegate<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 索引位置</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> index<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 对应集合项的index</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> String itemIndex<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> String item<span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// ...</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">appendSql</span><span class="token punctuation">(</span>String sql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    GenericTokenParser parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericTokenParser</span><span class="token punctuation">(</span><span class="token string">"#{"</span><span class="token punctuation">,</span> <span class="token string">"}"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TokenHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> String <span class="token function">handleToken</span><span class="token punctuation">(</span>String content<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String newContent <span class="token operator">=</span> 
          content<span class="token punctuation">.</span><span class="token function">replaceFirst</span><span class="token punctuation">(</span><span class="token string">"^\\s*"</span> <span class="token operator">+</span> item <span class="token operator">+</span> <span class="token string">"(?![^.,:\\s])"</span><span class="token punctuation">,</span> <span class="token function">itemizeItem</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>itemIndex <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> newContent<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          newContent <span class="token operator">=</span> 
            content<span class="token punctuation">.</span><span class="token function">replaceFirst</span><span class="token punctuation">(</span><span class="token string">"^\\s*"</span> <span class="token operator">+</span> itemIndex <span class="token operator">+</span> <span class="token string">"(?![^.,:\\s])"</span><span class="token punctuation">,</span> 
                                 <span class="token function">itemizeItem</span><span class="token punctuation">(</span>itemIndex<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">"#{"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>newContent<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"}"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    delegate<span class="token punctuation">.</span><span class="token function">appendSql</span><span class="token punctuation">(</span>parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getUniqueNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> delegate<span class="token punctuation">.</span><span class="token function">getUniqueNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>6、ChooseSqlNode</strong></p>
<p>如果在编写动态<code>SQL</code>语句时需要类似<code>Java</code>中的<code>switch</code>语句的功能，可以考虑使用<code>&lt;choose&gt;</code>、<code>&lt;when&gt;</code>和<code>&lt;otherwise&gt;</code>三个标签的组合。<code>MyBatis</code>会将<code>&lt;choose&gt;</code>标签解析成<code>ChooseSqlNode</code>，将<code>&lt;when&gt;</code>标签解析成<code>IfSqlNode</code>，将<code>&lt;otherwise&gt;</code>标签解析成<code>MixedSqlNode</code>。</p>
<p><code>ChooseSqlNode.apply()</code>方法的逻辑比较简单，首先遍历<code>ifSqlNodes</code>集合并调用其中<code>SqlNode</code><br>对象的<code>apply()</code>方法，然后根据前面的处理结果决定是否调用<code>defaultSqlNode</code>的<code>apply()</code>方法。</p>
<p><strong>7、VarDecISqINode</strong></p>
<p><code>VarDeclSqlNode</code>表示的是动态<code>SQL</code>语句中的<code>&lt;bind&gt;</code>节点,该节点可以从<code>OGNL</code>表达式中创建一个变量并将其记录到上下文中。</p>
<p>在<code>VarDecISqINode</code>中通过<code>name</code>字段记录<code>&lt;bind&gt;</code>节点的<code>name</code>属性值，<code>expression</code>字段记录<code>&lt;bind&gt;</code>节点的<code>value</code>属性值。</p>
<h2 id="SqlSourceBuilder"><a href="#SqlSourceBuilder" class="headerlink" title="SqlSourceBuilder"></a>SqlSourceBuilder</h2><p>在经过<code>SqlNode.apply()</code>方法的解析之后，<code>SQL</code>语句会被传递到<code>SqlSourceBuilder</code>中进行进一步的解析。</p>
<p><code>SqISourceBuilder</code>主要完成了两方面的操作，一方面是解析<code>SQL</code>语句中的<code>#{}</code><br>占位符中定义的属性，格式类似于<code>#{__frc_item_0,javaType=int,jdbcType=NUMERIC,typeHandler=MyTypeHandler}</code>，另一方面是将<code>SQL</code>语句中的<code>#{}</code>占位符替换成<code>?</code>占位符。</p>
<p><code>SqlSourceBuilder</code>也是<code>BaseBuilder</code>的子类之一，其核心逻辑位于<code>parse()</code>方法中。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> SqlSource <span class="token function">parse</span><span class="token punctuation">(</span>
  String originalSql<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> parameterType<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> additionalParameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 第一个参数是经过SqlNode.apply()方法处理之后的sql语句</span>
  <span class="token comment" spellcheck="true">// 第二个参数是用户传入的实参类型</span>
  <span class="token comment" spellcheck="true">// 第三个参数记录了形参与实参的对应关系，其实就是经过SqlNode.apply()方法处理后的DynamicContext.bindings集合</span>

  <span class="token comment" spellcheck="true">// 创建ParameterMappingTokenHandler对象， 它是解析#{}占位符中的参数属性以及替换占位符的核心</span>
  ParameterMappingTokenHandler handler <span class="token operator">=</span> 
    <span class="token keyword">new</span> <span class="token class-name">ParameterMappingTokenHandler</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> parameterType<span class="token punctuation">,</span> additionalParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 配合ParameterMappingTokenHandler解析占位符</span>
  GenericTokenParser parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GenericTokenParser</span><span class="token punctuation">(</span><span class="token string">"#{"</span><span class="token punctuation">,</span> <span class="token string">"}"</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  String sql <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>originalSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StaticSqlSource</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> sql<span class="token punctuation">,</span> handler<span class="token punctuation">.</span><span class="token function">getParameterMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="DynamicSqlSource"><a href="#DynamicSqlSource" class="headerlink" title="DynamicSqlSource"></a>DynamicSqlSource</h2><p><code>DynamicSqlSource</code>负责解析动态<code>SQL</code>语句，也是最常用的<code>Sqlource</code>实现之一。<code>SqlNode</code>中使用了组合模式，形成了一个树状结构，<code>DynamicSqlSource</code>中使用<code>rootSqlNode</code>字段(<code>SqlNode</code>类型)记录了待解析的<code>SqlNode</code>树的根节点。</p>
<p><code>DynamicSqlSource.getBoundSql()</code>方法：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> BoundSql <span class="token function">getBoundSql</span><span class="token punctuation">(</span>Object parameterObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 创建DynamicContext对象</span>
  DynamicContext context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicContext</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 通过调用rootSqlNode.apply()方法调用整个树形结构中全部SqlNode.apply()方法。</span>
  <span class="token comment" spellcheck="true">// 每个SqlNode的apply()方法都将解析得到的SQL语句片段追加到context中，</span>
  <span class="token comment" spellcheck="true">// 最终通过context.getSql()得到完整的SQL语句</span>
  rootSqlNode<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  SqlSourceBuilder sqlSourceParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSourceBuilder</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> parameterType <span class="token operator">=</span> parameterObject <span class="token operator">==</span> null <span class="token operator">?</span> 
    Object<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">:</span> parameterObject<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  SqlSource sqlSource <span class="token operator">=</span> sqlSourceParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                                              parameterType<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 创建BoundSql对象，并将DynamicContext.bindings中的参数信息复制到其</span>
  BoundSql boundSql <span class="token operator">=</span> sqlSource<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> entry <span class="token operator">:</span> context<span class="token punctuation">.</span><span class="token function">getBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    boundSql<span class="token punctuation">.</span><span class="token function">setAdditionalParameter</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> boundSql<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://gitee.com/cayzlh/img-repo/raw/master/2020/08/10441615985826561598582656771.png" alt="image-20200828104415997"></p>
<h2 id="RawSqISource"><a href="#RawSqISource" class="headerlink" title="RawSqISource"></a>RawSqISource</h2><p><code>RawSqISource</code>是<code>SqlSource</code>的另一个实现，其逻辑与<code>DynamicSqlSource</code>类似，但是执行时机不一样，处理的<code>SQL</code>语句类型也不一样。</p>
<p>前面介绍<code>XMLScriptBuilder.parseDynamicTags()</code>方法时提到过，如果节点只包含<code>#{}</code>占位符，而不包含动态<code>SQL</code>节点或未解析的<code>${}</code>占位符的话，则不是动态<code>SQL</code>语句，会创建相应的<code>StaticTextSqlNode</code>对象。</p>
<p>在<code>XMLScriptBuilder.parseScriptNode()</code>方法中会判断整个<code>SQL</code>节点是否为动态的，如果不是动态的<code>SQL</code>节点，则创建相应的<code>RawSqlSource</code>对象。</p>
<p><strong><code>RawSqlSource</code>在构造方法中首先会调用<code>getSql()</code>方法，其中通过调用<code>SqlNode.apply()</code>方法完成<code>SQL</code>语句的拼装和初步处理；</strong>之后会使用<code>SqlSourceBuilder</code>完成占位符的替换和<code>ParameterMapping</code>集合的创建，并返回<code>StaticSqlSource</code>对象。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RawSqlSource</span> <span class="token keyword">implements</span> <span class="token class-name">SqlSource</span> <span class="token punctuation">{</span>

  <span class="token keyword">private</span> <span class="token keyword">final</span> SqlSource sqlSource<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">RawSqlSource</span><span class="token punctuation">(</span>Configuration configuration<span class="token punctuation">,</span> SqlNode rootSqlNode<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> parameterType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 调用getsql()方法，完成SQL语句的拼装和初步解析</span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> <span class="token function">getSql</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> rootSqlNode<span class="token punctuation">)</span><span class="token punctuation">,</span> parameterType<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token function">RawSqlSource</span><span class="token punctuation">(</span>Configuration configuration<span class="token punctuation">,</span> String sql<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> parameterType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SqlSourceBuilder sqlSourceParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSourceBuilder</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">=</span> parameterType <span class="token operator">==</span> null <span class="token operator">?</span> Object<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">:</span> parameterType<span class="token punctuation">;</span>
    sqlSource <span class="token operator">=</span> sqlSourceParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token keyword">static</span> String <span class="token function">getSql</span><span class="token punctuation">(</span>Configuration configuration<span class="token punctuation">,</span> SqlNode rootSqlNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    DynamicContext context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicContext</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rootSqlNode<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> BoundSql <span class="token function">getBoundSql</span><span class="token punctuation">(</span>Object parameterObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> sqlSource<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>无论是<code>StaticSqlSource</code>、<code>DynamicSqlSource</code>还是<code>RawSqlSource</code>，最终都会统一生成<code>BoundSql</code>对象，其中封装了<u>完整的<code>SQL</code>语句(可能包含<code>?</code>占位符)</u>、<u>参数映射关系(<code>parameterMappings</code>集合)</u>以及<u>用户传入的参数(<code>additionalParameters</code>集合)</u>。</p>
<p>另外，<code>DynamicSqlSource</code>负责处理动态<code>SQL</code>语句，<code>RawSqlSource</code>负责处理静态<code>SQL</code>语句，除此之外，<u>两者解析<code>SQL</code>语句的时机也不一样，前者的解析时机是在实际执行<code>SQL</code>语句之前，而后者则是在<code>MyBatis</code>初始化时完成<code>SQL</code>语句的解析。</u></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><p><strong>《MyBatis技术内幕》</strong></p>
</li>
<li><p>部分图片来源——<strong>《MyBatis技术内幕》</strong></p>
</li>
</ul>

            <!-- 文章结尾部分 -->
            
                
<div style="text-align:center;width:100%">
    <span class="octicon octicon-tag-add"></span>
    
        <a style="color: #24292e;" href="/blog/tags/MyBatis/">MyBatis</a>
    
        <a style="color: #24292e;" href="/blog/tags/%E3%80%8AMyBatis%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E3%80%8B/">《MyBatis技术内幕》</a>
    
        <a style="color: #24292e;" href="/blog/tags/%E6%A0%B8%E5%BF%83%E5%A4%84%E7%90%86%E5%B1%82/">核心处理层</a>
    
</div>



    <div style="text-align:center;width:100%">
        <img src="https://cdn.jsdelivr.net/gh/cayzlh/git-img-repository@master/uPic/640-2.gif">
    </div>




<div>
    <h4>相关推荐</h4>
    <ul class="post-copyright">
        
        <li class="post-copyright-author">
            <a href="/blog/2020/06/22/c499e157.html">核心处理层-MyBatis初始化</a>
        </li>
        
        <li class="post-copyright-author">
            <a href="/blog/2019/10/21/3f93d624.html">MyBatis快速入门</a>
        </li>
        
        <li class="post-copyright-author">
            <a href="/blog/2019/10/30/e275ec7f.html">基础支持层——binding模块</a>
        </li>
        
        <li class="post-copyright-author">
            <a href="/blog/2019/10/29/e275ec7f.html">基础支持层——Transaction</a>
        </li>
        
        <li class="post-copyright-author">
            <a href="/blog/2019/10/25/899df03d.html">基础支持层——反射模块</a>
        </li>
        
        <li class="post-copyright-author">
            <a href="/blog/2019/10/26/899df03d.html">基础支持层——日志模块</a>
        </li>
        
    </ul>
    <br><br>
</div>



<div>
    <h4>版权声明</h4>
    <blockquote>
        <ul class="post-copyright">
            <li class="post-copyright-author">
                <strong>本文来源： </strong>
                
                <a href="https://www.cayzlh.com/blog" title="🐳Ant丶" rel="noopener external nofollow noreferrer" target="_blank">🐳Ant丶</a></li>
            <li class="post-copyright-link">
                <strong>本文链接：</strong>
                <a href="https://www.cayzlh.com/2020/08/21/bebe404d.html" title="/blog/%E6%A0%B8%E5%BF%83%E5%A4%84%E7%90%86%E5%B1%82-SqlNode&SqlSource">https://www.cayzlh.com/2020/08/21/bebe404d.html</a>
            </li>
            <li class="post-copyright-license">
                <strong>版权声明： </strong>
                
                    文章内容仅用作学习和分享，如有雷同，纯属拷贝。
                
            </li>
        </ul>
    </blockquote>
</div>


            
            
                <div class="comment">
    <br><br><br>
    
</div>

            
        </div>
        <div class="col-md-3 markdown-body">
            <h4>文章目录</h4>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#组合模式"><span class="toc-text">组合模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OGNL表达式"><span class="toc-text">OGNL表达式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DynamicContext"><span class="toc-text">DynamicContext</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SqlNode"><span class="toc-text">SqlNode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SqlSourceBuilder"><span class="toc-text">SqlSourceBuilder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DynamicSqlSource"><span class="toc-text">DynamicSqlSource</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RawSqISource"><span class="toc-text">RawSqISource</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol>
        </div>
    </div>
    
</article>


<script>
    hljs.initHighlightingOnLoad();
</script>
</main>
<footer class="container">
    <div class="site-footer">
        
    <div class="card text-center">
        <ul class="list-inline" style="margin-left: 0;">
            
                <li>
                    <a target="_blank" href="https://github.com/cayzlh" rel="external nofollow noopener noreferrer">
                          <span class="fa-stack fa-lg">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-github fa-stack-1x fa-inverse">
                                
                            </i>
                          </span>
                    </a>
                </li>
            
                <li>
                    <a target="_blank" href="mailto:chenanyu@cayzlh.com">
                          <span class="fa-stack fa-lg">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-envelope fa-stack-1x fa-inverse">
                                
                            </i>
                          </span>
                    </a>
                </li>
            
        </ul>
    </div>


        <div class="site-footer-links mobile-hidden">
            
                
                
            
        </div>

        <div class="site-footer-links mobile-hidden">
        
            <span class="meta-info-index hvr-grow">
                
                    <a href="https://www.cayzlh.com">
                        🐳Ant丶 &copy; 2020
                    </a>
                
            </span>
        
        
            <span class="meta-info-index hvr-grow">
                <a href="http://beian.miit.gov.cn" target="_blank" rel="external nofollow noopener noreferrer">粤ICP备20058712号-1</a>
            </span>
        
        </div>

        

        
    </div>
    

    
        <!-- Third-Party JS -->
        <script type="text/javascript" src="/blog/js/thirdparty/geopattern.min.js"></script>
        <!-- My JS -->
        <script type="text/javascript" src="/blog/js/script.js"></script>
    

    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
        </script>
    
</footer>
</body>
</html>